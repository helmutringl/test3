<script>
let watchId = null, marker = null;

function startWatch() {
  if (watchId !== null) return;
  watchId = navigator.geolocation.watchPosition(pos => {
    const { latitude, longitude } = pos.coords;
    if (!marker) {
      marker = L.marker([latitude, longitude]).addTo(map).bindPopup("Du bist hier");
    }
    marker.setLatLng([latitude, longitude]);
  }, err => {
    if (err.code === err.PERMISSION_DENIED) {
      alert("Standort verweigert.\nSafari: aA → Website-Einstellungen → Standort: Erlauben\noder: Einstellungen → Ortungsdienste → Safari-Websites.");
    } else {
      alert("GPS-Fehler: " + err.message);
    }
  }, { enableHighAccuracy: true, maximumAge: 10000, timeout: 15000 });
}

async function requestOnceThenWatch() {
  try {
    // 1) Einmalig prompten (iOS zeigt hier zuverlässig den Dialog)
    await new Promise((resolve, reject) => {
      navigator.geolocation.getCurrentPosition(
        () => resolve(), err => reject(err),
        { enableHighAccuracy: true, maximumAge: 0, timeout: 15000 }
      );
    });
    // 2) Danach dauerhaft verfolgen
    startWatch();
  } catch (err) {
    if (err && err.code === err.PERMISSION_DENIED) {
      alert("Standort ist blockiert.\nBitte in iOS freigeben (siehe Hinweise).");
    } else {
      alert("GPS-Fehler: " + (err?.message || err));
    }
  }
}

document.getElementById('loc').addEventListener('click', () => {
  if (watchId === null) {
    requestOnceThenWatch();
    document.getElementById('loc').textContent = "📍 GPS aktiv";
  } else {
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
    if (marker) { map.removeLayer(marker); marker = null; }
    document.getElementById('loc').textContent = "📍 Meine Position";
  }
});
</script>
